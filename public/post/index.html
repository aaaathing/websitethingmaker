<!DOCTYPE html>
<html>
  <head>
    <title>Post</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/assets/common.css">
    <style>
      h1, h3{
        margin:0px;
      }
      h1{font-size:50px;}
      #right{
        float:right;
      }
      #options{
        vertical-align:middle;
      }
      /*start here*/
      /*#comment-area{
        border:1px solid gray;
        overflow:auto;
      }
      #comment-nav{
        background:#f5f5f5;
        padding:10px;
        padding-bottom:0;
        margin-bottom:10px;
        border-bottom:1px solid gray;
      }
      body[theme=dark] #comment-nav{
        background:#444;
      }
      #comment-nav > div{
        padding:10px;
        display:inline-block;
        font-size:13px;
        cursor:pointer;
      }
      #comment-nav > div.selected{
        background:white;
        border:1px solid gray;
        border-top-left-radius:5px;
        border-top-right-radius:5px;
        border-bottom:1px solid white;
        position:relative;
        top:1px;
      }
      body[theme=dark] #comment-nav > div.selected{
        background:#333;
        border-bottom:#333;
      }
      #comment-area button{
        float:right;
        margin:10px 10px 10px 0px;
      }*/
      #comment{
        width:calc(100% - 20px);
        height:100px;
        font-family:inherit;
        border:1px solid #bbb;
        margin:0px 10px;
        resize:vertical;
        display:block;
      }
      /*#comment-previewBox{
        width:calc(100% - 20px);
        border:1px solid #bbb;
        margin:0px 10px;
        padding:20px;
      }
      #comment-format{
        margin:0px 10px;
        background:#f7f7f7;
        font-size:13px;
        border-right:1px solid gray;
        display:flex;
        flex-flow: row wrap;
      }
      body[theme=dark] #comment-format{
        background:#333;
      }
      #comment-format > div{
        padding:4px;
        cursor:pointer;
        flex-grow:1;
        border-left:1px solid gray;
        border-bottom:1px solid gray;
      }
      #comment-format > div:hover{
        background:#eee;
      }
      body[theme=dark] #comment-format > div:hover{
        background:#111;
      }*//*end here*/

      #by img{
        width:30px;
        height:30px;
        border-radius:100%;
        border:1px solid gray;
        vertical-align:middle;
        margin-right:10px;
      }
      #postContent{
        margin:16px 0;
      }
      .right{float:right;}

      .navbar a[nav=posts]{
        background:gray;
      }

      #timestamp{color:gray}
    </style>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VRNT3CCCGH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VRNT3CCCGH');
</script>
  </head>
	<!-- Â©, by thingmaker. thingmaker.us.eu.org -->
  <body>
    <div id="contentBG">
      <div id="content">
        <a href="/posts">&lt; Back to all posts</a>
        <div id="loading">Loading...</div>
        <h1 id="title" class="skeletonText block longSkeleton">&nbsp;</h1>
        <div id="timestamp"></div>
        <h3 id="by" class="skeletonText" style="display:inline-block;">&nbsp;</h3>
        <div id="vote" style="display:inline-block;margin-left:16px;"></div>
        <div id="right">
          <button id="follow"></button>
          <div id="options"></div>
        </div>
        <div id="postContent" class="format"></div>

        <h3 id="commentsHeader">Comments</h3>
        <i style="color:gray;">The comments are live.</i>
        <br><br>
        <!--<div id="comment-area">
          <div id="comment-nav">
            <div class="selected" id="comment-write" onclick="commentMode('write')">Write</div><!--
         - -><div onclick="commentMode('preview')" id="comment-preview">Preview</div>
          </div>
          <textarea id="comment" placeholder="Write a comment..."></textarea>
          <div id="comment-previewBox" class="format" style="display:none;"></div>
          <div id="comment-format">
            <input type="file" id="upload" onchange="uploadIt(this.files[0], this.getAttribute('mediaType'))" style="display:none;">
            <div onclick="upload.accept='image/*'; upload.setAttribute('mediaType', 'img'); upload.click()">Image</div>
            <div onclick="upload.accept='video/*'; upload.setAttribute('mediaType', 'video'); upload.click()">Video</div>
            <div onclick="addToComment(`<img src='${prompt(&quot;URL for image&quot;)}'>`)">Image from web</div>
            <div onclick="addToComment(`<video controls src='${prompt(&quot;URL for video&quot;)}'></video>`)">Video from web</div>
            <div onclick="addToComment('<h1>Heading</h1>')">Heading 1</div>
            <div onclick="addToComment('<h2>Heading</h2>')">Heading 2</div>
            <div onclick="addToComment('<h3>Heading</h3>')">Heading 3</div>
            <div onclick="addToComment('<h4>Heading</h4>')">Heading 4</div>
            <div onclick="addToComment('<h5>Heading</h5>')">Heading 5</div>
            <div onclick="addToComment('<h6>Heading</h6>')">Heading 6</div>
            <div onclick="addToComment('<p>Paragraph. Blah blah blah blah blah, blah blah blah.</p>')">Paragraph</div>
            <div onclick="addToComment('<ul><li>one</li><li>two</li><li>three</li></ul>')">List</div>
            <div onclick="addToComment('<ol><li>one</li><li>two</li><li>three</li></ol>')">Numbered list</div>
            <div onclick="addToComment(`<a href='${prompt(&quot;URL for link&quot;)}'>Link</a>`)">Link with custom text</div>
            <div onclick='addToComment(`<code codeType="javascript">//Code here</code>`)'>Code</div>
            <div onclick='addToComment(`<code codeType="javascript" inline>//Code here</code>`)'>Inline Code</div>
          </div>
          <button onclick="comment()">Post</button>
          <pre id="error" style="color:red;"></pre>
        </div>-->
        <script src="/assets/textbox.js" textboxId="commentTextbox" textboxPlaceholder="Write a comment..." buttonText="Post"></script>

        <div id="comments"></div>
      </div>
    </div>
    <script src="/assets/common.js"></script>
    <script>
      const urlParams = new URLSearchParams(location.search);
      var id = urlParams.get('id')
      var myUsername = "", postUsername
      var followBtn = document.getElementById("follow")
      var following
      var upload = document.querySelector('#upload')
      var commentEl = document.querySelector("#comments")

      function follow(yes, remote){
        following = yes
        if(remote){
          followBtn.innerHTML = (yes ? "Stop getting" : "Get")+" notified about changes"
        }else{
          fetch(serverBase+"/server/followPost/"+id, {
            method: "POST",
            credentials: 'include',
            body: JSON.stringify({follow: yes})
          }).then(r => r.text()).then(res => {
            if(res !== "ok"){
              return alert("Following Error!")
            }
            followBtn.innerHTML = (yes ? "Stop getting" : "Get")+" notified about changes"
          })
        }
      }

      followBtn.onclick = () => {
        follow(!following)
      }

      let allComments = [], timeInterval
      async function fetchPost(){
      fetch(serverBase+"/server/post/"+id).then(r =>  r.json()).then(async d => {
        if(!d) return location.href = "/posts"
        myUsername = userInfo && userInfo.username
        postUsername = d.username
        let user = await fetch(serverBase+"/server/account/"+d.username).then(r => r.json())
        let s = document.querySelectorAll(".skeletonText")
        for(var i=0; i<s.length; i++){
          s[i].classList.remove("skeletonText")
        }
        document.querySelector("#loading").classList.add("hidden")

        document.title = "Post: "+d.title
        document.querySelector("#title").innerHTML = sanitize(d.title)
        document.querySelector("#timestamp").innerHTML = timeString(d.timestamp)
        document.querySelector("#by").innerHTML = "by <a href='/user?user="+d.username+"'><img src='"+sanitize(user && user.pfp)+"'>"+d.username+"</a>"
        enableUserPopup(document.querySelector("#by a"), d.username)
        if(user) makeVotes(document.querySelector("#vote"),user,myUsername)
				if(d.bg){
					document.body.style.setProperty("--bgImg", "url('"+d.bg+"')")
					document.body.classList.add("bgImg")
				}
        document.querySelector("#postContent").innerHTML = format(d.content)

        let comments = d.comments || []
        commentsHeader.innerHTML = "Comments ("+comments.length+")"
        commentEl.innerHTML = ""
        for(var i=0; i<comments.length; i++){
          var c = comments[i]
          if(c.hide) continue
          addComment(c)
        }
        if(timeInterval !== undefined) clearInterval(timeInterval)
        timeInterval = setInterval(() => {
          document.querySelector("#timestamp").innerHTML = timeString(d.timestamp)
          for(let c of allComments){
            if(!c.timestamp) continue
            let time = document.querySelector("#comment"+c.id+" .time").innerHTML = timeString(c.timestamp)
          }
        },10000)

        if(location.hash[0] === "#"){
          setTimeout(() => {
            var el = document.querySelector(location.hash)
            if(el){
              el.scrollIntoView({block:"center",behavior:"instant"})
              el.style.animation = "1s linear flash"
            }
          }, 10)
        }

        (function(){
          let r = userInfo
          if(!r) return
          myUsername = r.username
          if(d.username === myUsername || r.admin || r.enoughVotes){
            document.querySelector("#options").innerHTML = `
  <a href="/editPost?id=${window.id}">Edit</a>&nbsp;&nbsp;
  <a onclick="deletePost()">Delete</a>
  `
          }
          if(d.followers){
            follow(d.followers.includes(myUsername), true)
          }else{
            follow(false, true)
          }
        })()
      })
      }
      var commentBox = document.querySelector("#commentTextbox .comment-box")
      //var previewBox = document.getElementById("comment-previewBox")
      
      function comment(c){
        c = c || commentBox.value

        fetch(serverBase+"/server/commentPost/"+id, {
          method:"POST",
          body: JSON.stringify({comment: c}),
          credentials: 'include'
        }).then(r => r.json()).then(r => {
          if(r.success){
            //addComment({id:r.id,username:myUsername,timestamp:Date.now(),comment:c})
            commentBox.value = ""
            //previewBox.innerHTML = ""
          }else{
            document.querySelector("#error").innerHTML = r.message
          }
        })
      }
      document.querySelector("#commentTextbox .comment-button").onclick = () => comment()
      function addComment(c){
        var id = "comment"+c.id
        var cel = document.createElement("div")
        cel.classList.add("comment")
        cel.id = id
        cel.innerHTML =
        "<div class='top'><a class='user' href='user?user="+c.username+"'>"
        +"<img class='pfp' src='"+serverBase+"/server/pfp/"+c.username+"' loading='lazy'>"
        +"<span class='username'>"+c.username+"</span></a>"
        +"<span class='right time' style='padding:0 8px;'>"+(c.timestamp ? timeString(c.timestamp) : "")+"</span>"
        +(myUsername === c.username || myUsername === postUsername || userInfo && userInfo.admin ? "<a class='right' onclick='deleteComment(\""+c.id+"\")'>Delete</a>" : "")
        +"</div>"
        +"<div class='commentCotent format'>"+format(c.comment)+"</div>"
        commentEl.appendChild(cel)
        enableUserPopup(cel.querySelector(".user"), c.username)
        allComments.push(c)
      }

      var ws
      function initWs(){
        ws = new WebSocket("wss://"+location.host+"/postWs?id="+id)
        ws.onmessage = function(msg){
          let packet = /*msg.data*/JSON.parse(msg.data)
          if(packet.type === "comment"){
            addComment(packet.data)
          }else if(packet.type === "deleteComment"){
            document.getElementById("comment"+packet.data).style.display = "none"
            let idx = allComments.findIndex(r => r.id === packet.data)
            if(idx !== -1) allComments.splice(idx,1)
          }else if(packet.type === "edit"){
            document.querySelector("#postContent").innerHTML = format(packet.data)
          }
        }
        ws.onclose = function(){
          ws = null
        }
        ws.onerror = () => ws.close()
      }
      if(window.doLiveContent) setInterval(() => {
        if(!ws && navigator.onLine){
          initWs()
          fetchPost()
        }
      }, 1000)
      fetchPost()
      if(window.doLiveContent) initWs()

      function deletePost(){
        if(!confirm("Are you sure you want to delete this post? Don't delete too many useless but safe posts.")) return
        fetch(serverBase+"/server/deletePost/"+id, {
          method:"DELETE",
          credentials:'include'
        }).then(r => r.text()).then(r => {
          if(r === "ok"){
            location.href = "/posts"
          }else alert(r)
        }).catch(alert)
      }

      /*function commentMode(m){
        if(m === "write"){
          commentBox.style.display = ""
          previewBox.style.display = "none"
          document.getElementById("comment-write").classList.add("selected")
          document.getElementById("comment-preview").classList.remove("selected")
        }else if(m === "preview"){
          commentBox.style.display = "none"
          previewBox.style.display = ""
          previewBox.innerHTML = format(commentBox.value, previewBox.id)
          document.getElementById("comment-write").classList.remove("selected")
          document.getElementById("comment-preview").classList.add("selected")
        }
      }

      function readFile(blob){
        return new Promise(function(resolve, reject){
          const reader = new FileReader()
          reader.onload = () => resolve(reader.result)
          reader.onerror = reject
          reader.readAsArrayBuffer(blob)
        })
      }
      async function uploadIt(d, type){
        var buffer = await readFile(d)
        var res = await fetch(serverBase+"/server/newMedia", {
          method: 'POST',
          body: buffer,
          headers: {
            "Content-Type": d.type
          }
        }).then(r => r.json())
        if(res.success){
          addToComment("<"+(type || "img")+" src='"+res.url+"'"+(type==="video"?"controls":"")+"/>")
        }else alert(res.message)
      }

      function addToComment(str){
        commentBox.value += str
        previewBox.innerHTML = format(commentBox.value, previewBox.id)
      }*/

      function deleteComment(cid){
        var c = document.getElementById("comment"+cid)
        fetch(serverBase+"/server/deletePostComment/"+id, {
          credentials:'include',
          method: 'POST',
          body: JSON.stringify({cid})
        }).then(d => d.text()).then(d => {
          if(d === "error") return alert("error")
          c.style.display = "none"
          let idx = allComments.findIndex(r => r.id === cid)
          if(idx !== -1) allComments.splice(idx,1)
        })
      }
    </script>
  </body>
</html>